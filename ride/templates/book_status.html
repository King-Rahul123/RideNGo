{% extends "base.html" %}
{% load static %}

{% block style %}
    <link rel="stylesheet" href="{% static 'css/book_ride.css' %}">
    <!-- BOOTSTRAP 5 CSS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Font Awesome (for map icon) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        .center-card { max-width: 720px; margin: 30px auto; }
        .step-card { border-radius: 12px; box-shadow: 0 8px 24px rgba(12,23,48,0.06); }
        .muted-small { font-size: .9rem; color: #6c757d; }
        .otp-highlight { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; letter-spacing: 1px; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1200; }
        .progress-sm { height: 6px; border-radius: 6px; }
        .copy-otp { cursor: pointer; }
    </style>
{% endblock style %}

{% block script %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    {% comment %} <script src="{% static 'js/booking.js' %}"></script> {% endcomment %}
    <!-- BOOTSTRAP 5 JS BUNDLE -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock script %}

{% block main-content %}
<div class="container center-card">
    <div class="card p-4 step-card">
        <div class="d-flex align-items-center mb-3">
            <h4 class="mb-0 me-auto"><i class="fa fa-shield-halved me-2"></i> Booking status (OTP verification)</h4>
            <small class="muted-small">Secure & quick</small>
        </div>

        <!-- messages from Django (server) -->
        {% if messages %}
            {% for m in messages %}
                <div class="alert alert-{{ m.tags }} alert-sm">{{ m }}</div>
            {% endfor %}
        {% endif %}
        <div id="booking-root" data-send-url="{% url 'booking_send_otp' %}" data-verify-url="{% url 'booking_verify_otp' %}">
            <div id="alerts"></div>
            <!-- Step 1: Enter mobile -->
            <div id="step-mobile" class="mb-3">
                <label class="form-label">Mobile number</label>
                <div class="input-group">
                    <input id="mobileInput" class="form-control form-control-lg" placeholder="+91 xxxxx xxxxx" value="{{ prefill_mobile|default:'' }}" aria-label="Mobile number">
                    <button id="sendOtpBtn" class="btn btn-primary btn-lg" type="button">
                        <span id="sendOtpSpinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                        Send OTP
                    </button>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <small class="muted-small">We'll send a one-time password (OTP) to this number.</small>
                    <small class="muted-small">Dev-mode: OTP prints to server console.</small>
                </div>
            </div>

            <!-- Step 2: Enter OTP -->
            <div id="step-otp" class="card p-3 mb-3" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <label class="form-label mb-0">Enter OTP</label>
                        <div class="muted-small">Type the code you received</div>
                    </div>
                    <div>
                        <small id="otpExpiryLabel" class="muted-small">Expires in â€”</small>
                    </div>
                </div>

                <div class="d-flex gap-2 align-items-center">
                    <input id="otpInput" class="form-control form-control-lg otp-highlight" placeholder="123456" inputmode="numeric" pattern="\d*" maxlength="6" style="max-width:220px;">
                    <button id="verifyOtpBtn" class="btn btn-success btn-lg">Verify</button>
                    <button id="resendOtpBtn" class="btn btn-link">Resend</button>
                </div>

                <div class="mt-3">
                    <div class="progress progress-sm">
                        <div id="otpProgress" class="progress-bar bg-success" role="progressbar" style="width:100%"></div>
                    </div>
                    <div class="mt-2 d-flex justify-content-between">
                        <small id="otpActions" class="muted-small"></small>
                    </div>
                </div>
            </div>

            <!-- Step 3: Booking status (shown after OTP) -->
            <div id="step-status" style="display:none;">
                <form id="statusForm" method="POST" action="{% url 'booking_status' %}">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Booking ID (optional)</label>
                            <input name="booking_id" id="booking_id" class="form-control" placeholder="Booking id (optional)">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select">
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="on_trip">On Trip</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Remarks</label>
                            <textarea name="remarks" id="remarks" class="form-control" rows="3"></textarea>
                        </div>

                        <div class="col-12 text-end">
                            <button type="submit" class="btn btn-primary btn-lg">Save Booking Status</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script src="{% static "js/booking_status.js" %}"></script>
{% endblock main-content %}

